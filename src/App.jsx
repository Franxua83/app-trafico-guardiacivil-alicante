import React, { useState, useEffect, useMemo, useRef, useCallback } from "react";â€¨import { initializeApp } from "firebase/app";â€¨import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";â€¨import {â€¨Â  getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot,â€¨Â  serverTimestamp, setDoc, updateDoc, query, where,â€¨} from "firebase/firestore";â€¨import {â€¨Â  X, Lock, LogOut, Trash2, Users, Shield, Briefcase, UserCheck, Eye, Key,â€¨Â  RefreshCw, ArrowRightLeft, Undo2, Bot, Car, ChevronRight, MessageCircle,â€¨Â  Send, Settings, MapPin, ChevronLeft, Bike, FileText, CalendarCheck, Info,â€¨Â  Star, Calculator, Divide // Iconos nuevosâ€¨} from "lucide-react";â€¨â€¨// --- CONFIGURACIÃ“N FIREBASE ---â€¨const firebaseConfig = {â€¨Â  apiKey: "AIzaSyDI0b2KvCE91g7caKTMK8C65VStYhlfhXA",â€¨Â  authDomain: "vacaciones-equipo.firebaseapp.com",â€¨Â  projectId: "vacaciones-equipo",â€¨Â  storageBucket: "vacaciones-equipo.firebasestorage.app",â€¨Â  messagingSenderId: "363688110200",â€¨Â  appId: "1:363688110200:web:d8821656bb0618122de58d",â€¨};â€¨â€¨const app = initializeApp(firebaseConfig);â€¨const auth = getAuth(app);â€¨const db = getFirestore(app);â€¨const appId = "vacaciones-equipo-2026";â€¨â€¨// --- CONSTANTES Y CONFIGURACIÃ“N ---â€¨const LOGO_URL = "https://i.postimg.cc/d1kK6BtW/Gemini_Generated_Image_7v8i3p7v8i3p7v8i.png";â€¨const GPT_URL = "https://chatgpt.com/g/g-690e357144cc8191bad33044e9d2b5e3-gc-trafico";â€¨const FORM_PERMISOS_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeXJqKZW8pQqfGuJxbpAfwhqxzaBc6GGgt-sK0sgbTqZ_gqTw/viewform?embedded=true";â€¨â€¨// FECHAS GENERALESâ€¨const PERIOD_START = "2025-11-01";â€¨const PERIOD_END = "2027-01-31";â€¨const LIMIT_2025_END = "2026-03-08";â€¨const START_2026_START = "2026-02-01";â€¨â€¨// RANGOS ESPECIALESâ€¨const SS_RANGE = { start: "2026-03-10", end: "2027-04-20" };â€¨const NAV_RANGE_25 = { start: "2025-12-17", end: "2026-01-12" };â€¨const NAV_RANGE_26 = { start: "2026-12-17", end: "2027-01-12" };â€¨const NAVIDAD_WINDOWS = [NAV_RANGE_25, NAV_RANGE_26];â€¨â€¨// REGLAS DE CUPOâ€¨const MIN_WORKING_STAFF_FOR_AP = 2; // Regla AP: Deben quedar 2 trabajandoâ€¨const MAX_VACATION_PER_GROUP = 2; Â  // Regla VAC: Max 2 personasâ€¨const MAX_SPECIAL_PER_GROUP = 2;Â  Â  // Regla Nav/SS: Max 2 personasâ€¨â€¨// LÃMITES DE SALDOâ€¨const VACATION_LIMIT_2026 = 19;â€¨const AP_LIMIT_2026 = 6;â€¨const VACATION_LIMIT_2025_DEFAULT = 5; â€¨const AP_LIMIT_2025_DEFAULT = 2;â€¨â€¨const DEFAULT_USER_PIN = "1234";â€¨const DEFAULT_ADMIN_PIN = "9999";â€¨â€¨// SERVICIOS ESPECIALESâ€¨const SPECIAL_SERVICES_LIST = [â€¨Â  "Puertas M", "Puertas T", "Puertas N",â€¨Â  "Oficina M", "Oficina T",â€¨Â  "AFU", "PATIO", "DEX", "TIRO", "COMISIÃ“N DE SERVICIO"â€¨];â€¨â€¨// --- CICLOS DE TURNOS ---â€¨const CYCLE_MOTO_8H = ["M", "M", "M", "T", "T", "N", "S", "L", "L", "L", "L"];â€¨const CYCLE_EIS_NEW = ["M", "M", "N", "S", "L", "L", "L", "L"];â€¨â€¨// --- REFERENCIAS DE GRUPOS ---â€¨const REF_MOTO_G1 = "2026-01-09";â€¨const REF_MOTO_G2 = "2025-11-09";â€¨const REF_MOTO_G3 = "2025-11-03";â€¨const REF_MOTO_G4 = "2025-11-12";â€¨const REF_MOTO_G5 = "2025-11-07";â€¨â€¨// --- CONFIGURACIÃ“N DE GRUPOS ---â€¨const GROUPS = [â€¨Â  // MOTORISTASâ€¨Â  { id: "G3_MOTO", name: "Grupo 1", unit: "Destacamento Benidorm", category: "motoristas", refDate: REF_MOTO_G3, cycle: CYCLE_MOTO_8H },â€¨Â  { id: "G4_MOTO", name: "Grupo 2", unit: "Destacamento Benidorm", category: "motoristas", refDate: REF_MOTO_G4, cycle: CYCLE_MOTO_8H },â€¨Â  { id: "G1_MOTO", name: "Grupo 3", unit: "Destacamento Benidorm", category: "motoristas", refDate: REF_MOTO_G1, cycle: CYCLE_MOTO_8H },â€¨Â  { id: "G5_MOTO", name: "Grupo 4", unit: "Destacamento Benidorm", category: "motoristas", refDate: REF_MOTO_G5, cycle: CYCLE_MOTO_8H },â€¨Â  { id: "G2_MOTO", name: "Grupo 5", unit: "Destacamento Benidorm", category: "motoristas", refDate: REF_MOTO_G2, cycle: CYCLE_MOTO_8H },â€¨Â  // EIS BENIDORMâ€¨Â  { id: "EIS_BEN_G1", name: "Grupo 1", unit: "EIS Benidorm", category: "atestados", refDate: "2025-12-04", cycle: CYCLE_EIS_NEW },â€¨Â  { id: "EIS_BEN_G2", name: "Grupo 2", unit: "EIS Benidorm", category: "atestados", refDate: "2025-12-06", cycle: CYCLE_EIS_NEW },â€¨Â  // EIS ALICANTEâ€¨Â  { id: "EIS_ALC_G1", name: "Grupo 1", unit: "EIS Alicante", category: "atestados", refDate: "2025-12-05", cycle: CYCLE_EIS_NEW },â€¨Â  { id: "EIS_ALC_G2", name: "Grupo 2", unit: "EIS Alicante", category: "atestados", refDate: "2025-12-08", cycle: CYCLE_EIS_NEW },â€¨Â  { id: "EIS_ALC_G3", name: "Grupo 3", unit: "EIS Alicante", category: "atestados", refDate: "2025-12-10", cycle: CYCLE_EIS_NEW },â€¨Â  // EIS ORIHUELAâ€¨Â  { id: "EIS_ORI_G1", name: "Grupo 1", unit: "EIS Orihuela", category: "atestados", refDate: "2025-12-09", cycle: CYCLE_EIS_NEW },â€¨Â  { id: "EIS_ORI_G2", name: "Grupo 2", unit: "EIS Orihuela", category: "atestados", refDate: "2025-12-05", cycle: CYCLE_EIS_NEW },â€¨Â  // EIS TORREVIEJAâ€¨Â  { id: "EIS_TOR_G1", name: "Grupo 1", unit: "EIS Torrevieja", category: "atestados", refDate: "2025-12-07", cycle: CYCLE_EIS_NEW },â€¨Â  { id: "EIS_TOR_G2", name: "Grupo 2", unit: "EIS Torrevieja", category: "atestados", refDate: "2025-12-11", cycle: CYCLE_EIS_NEW },â€¨];â€¨â€¨// --- MIEMBROS ---â€¨const MEMBERS = [â€¨Â  { id: "tello", name: "Tello", group: "G1_MOTO", active: true },â€¨Â  { id: "beltran", name: "BeltrÃ¡n", group: "G1_MOTO", active: true },â€¨Â  { id: "dieguez", name: "DiÃ©guez", group: "G1_MOTO", active: true },â€¨Â  { id: "nando", name: "Nando", group: "G1_MOTO", active: true },â€¨Â  { id: "escribano", name: "Escribano", group: "G1_MOTO", active: true },â€¨Â  { id: "pena", name: "PeÃ±a", group: "G1_MOTO", active: true },â€¨Â  { id: "munoz", name: "MuÃ±oz", group: "G1_MOTO", active: false, status: "BAJA" },â€¨Â  { id: "josema", name: "Josema", group: "G2_MOTO", active: false, status: "BAJA" },â€¨Â  { id: "raul", name: "Raul", group: "G2_MOTO", active: true },â€¨Â  { id: "castillo", name: "Castillo", group: "G2_MOTO", active: true },â€¨Â  { id: "torregrosa", name: "Torregrosa", group: "G2_MOTO", active: true },â€¨Â  { id: "monzon", name: "Monzon", group: "G2_MOTO", active: true },â€¨Â  { id: "roman", name: "Roman", group: "G2_MOTO", active: true },â€¨Â  { id: "melero", name: "Melero", group: "G2_MOTO", active: true },â€¨Â  { id: "ismael", name: "Ismael", group: "G3_MOTO", active: true },â€¨Â  { id: "extremera", name: "Extremera", group: "G3_MOTO", active: true },â€¨Â  { id: "perojil", name: "Perojil", group: "G3_MOTO", active: true },â€¨Â  { id: "gabriel", name: "Gabriel", group: "G3_MOTO", active: true },â€¨Â  { id: "quintana", name: "Quintana", group: "G3_MOTO", active: true },â€¨Â  { id: "otero", name: "Otero", group: "G3_MOTO", active: true }, // âœ… OTERO - GRUPO 1â€¨Â  { id: "navarro", name: "Navarro", group: "G4_MOTO", active: false, status: "BAJA" },â€¨Â  { id: "ruben", name: "Ruben", group: "G4_MOTO", active: false, status: "BAJA" },â€¨Â  { id: "angel", name: "Angel", group: "G4_MOTO", active: false, status: "BAJA" },â€¨Â  { id: "delatorre", name: "De la Torre", group: "G4_MOTO", active: true },â€¨Â  { id: "gil", name: "Gil", group: "G4_MOTO", active: true },â€¨Â  { id: "marcos_moto", name: "Marcos", group: "G4_MOTO", active: true },â€¨Â  { id: "miriam", name: "Miriam", group: "G4_MOTO", active: true },â€¨Â  { id: "quilez", name: "Quilez", group: "G4_MOTO", active: true }, // âœ… QUILEZ - GRUPO 2â€¨Â  { id: "albero", name: "Albero", group: "G4_MOTO", active: true }, // âœ… ALBERO - GRUPO 2â€¨Â  { id: "sarabia", name: "Sarabia", group: "G5_MOTO", active: true },â€¨Â  { id: "pedroperez", name: "Pedro Perez", group: "G5_MOTO", active: true },â€¨Â  { id: "jorge", name: "Jorge", group: "G5_MOTO", active: true },â€¨Â  { id: "carpi", name: "Carpi", group: "G5_MOTO", active: true },â€¨Â  { id: "guillamon", name: "Guillamon", group: "G5_MOTO", active: true },â€¨Â  { id: "fajardo", name: "Fajardo", group: "G5_MOTO", active: true },â€¨Â  // EISâ€¨Â  { id: "barrientos", name: "C1 Barrientos", group: "EIS_BEN_G1", active: true },â€¨Â  { id: "alvaro", name: "GC Ãlvaro", group: "EIS_BEN_G1", active: true },â€¨Â  { id: "valverde_b", name: "GC Valverde", group: "EIS_BEN_G1", active: true },â€¨Â  { id: "ayuso", name: "GC Ayuso", group: "EIS_BEN_G1", active: true },â€¨Â  { id: "rabadan", name: "C1 RabadÃ¡n", group: "EIS_BEN_G2", active: true },â€¨Â  { id: "delacruz", name: "GC De la Cruz", group: "EIS_BEN_G2", active: true },â€¨Â  { id: "morales", name: "GC Morales", group: "EIS_BEN_G2", active: true },â€¨Â  { id: "yanez", name: "C1 YaÃ±ez", group: "EIS_ALC_G1", active: true },â€¨Â  { id: "hernandez", name: "GC Hernandez", group: "EIS_ALC_G1", active: true },â€¨Â  { id: "senderos", name: "GC Senderos", group: "EIS_ALC_G1", active: true },â€¨Â  { id: "monedero", name: "C1 Monedero", group: "EIS_ALC_G2", active: true },â€¨Â  { id: "javier_a", name: "GC Javier", group: "EIS_ALC_G2", active: true },â€¨Â  { id: "marcos_a", name: "GC Marcos", group: "EIS_ALC_G2", active: true },â€¨Â  { id: "sevilla", name: "GC Sevilla", group: "EIS_ALC_G2", active: true },â€¨Â  { id: "almendros", name: "CB Almendros", group: "EIS_ALC_G3", active: true },â€¨Â  { id: "marrodan", name: "GC Marrodan", group: "EIS_ALC_G3", active: true },â€¨Â  { id: "uxio", name: "GC Uxio", group: "EIS_ALC_G3", active: true },â€¨Â  { id: "maldonado", name: "C1 Maldonado", group: "EIS_ORI_G1", active: true },â€¨Â  { id: "javier_o", name: "GC Javier", group: "EIS_ORI_G1", active: true },â€¨Â  { id: "valverde_o", name: "GC Valverde", group: "EIS_ORI_G1", active: true },â€¨Â  { id: "marcos_o", name: "GC Marcos", group: "EIS_ORI_G1", active: true },â€¨Â  { id: "lopez", name: "GC Lopez", group: "EIS_ORI_G2", active: true },â€¨Â  { id: "parra", name: "GC Parra", group: "EIS_ORI_G2", active: true },â€¨Â  { id: "rafael", name: "GC Rafael", group: "EIS_ORI_G2", active: true },â€¨Â  { id: "francisco", name: "GC Francisco", group: "EIS_ORI_G2", active: true },â€¨Â  { id: "rebollo", name: "GC Rebollo", group: "EIS_TOR_G1", active: true },â€¨Â  { id: "rodriguez", name: "GC Rodriguez", group: "EIS_TOR_G1", active: true },â€¨Â  { id: "cabezas", name: "GC Cabezas", group: "EIS_TOR_G1", active: true },â€¨Â  { id: "melani", name: "GC Melani", group: "EIS_TOR_G1", active: true },â€¨Â  { id: "rivera", name: "GC Rivera", group: "EIS_TOR_G2", active: true },â€¨Â  { id: "tortosa", name: "GC Tortosa", group: "EIS_TOR_G2", active: true },â€¨Â  { id: "cerceda", name: "GC Cerceda", group: "EIS_TOR_G2", active: true },â€¨Â  { id: "berzosa", name: "GC Berzosa", group: "EIS_TOR_G2", active: true },â€¨];â€¨â€¨const SHIFT_STYLES = {â€¨Â  M: { label: "M", bg: "bg-yellow-100", text: "text-yellow-800", border: "border-yellow-200", workDay: true },â€¨Â  T: { label: "T", bg: "bg-orange-100", text: "text-orange-800", border: "border-orange-200", workDay: true },â€¨Â  N: { label: "N", bg: "bg-blue-100", text: "text-blue-800", border: "border-blue-200", workDay: true },â€¨Â  S: { label: "S", bg: "bg-emerald-600", text: "text-white", border: "border-emerald-700", workDay: false },â€¨Â  L: { label: "L", bg: "bg-emerald-100", text: "text-emerald-800", border: "border-emerald-200", workDay: false },â€¨};â€¨â€¨const getShiftStyle = (shiftCode) => {â€¨Â  Â  if (SHIFT_STYLES[shiftCode]) return SHIFT_STYLES[shiftCode];â€¨Â  Â  return { â€¨Â  Â  Â  Â  label: shiftCode.length > 5 ? shiftCode.substring(0,3) + ".." : shiftCode,â€¨Â  Â  Â  Â  fullLabel: shiftCode,â€¨Â  Â  Â  Â  bg: "bg-indigo-100", â€¨Â  Â  Â  Â  text: "text-indigo-800", â€¨Â  Â  Â  Â  border: "border-indigo-200", â€¨Â  Â  Â  Â  workDay: true â€¨Â  Â  };â€¨};â€¨â€¨const TYPE_STYLES = {â€¨Â  vacation: { color: "bg-emerald-600", label: "VAC" },â€¨Â  ap: { color: "bg-purple-600", label: "AP" },â€¨Â  baja: { color: "bg-slate-500", label: "BAJA" },â€¨Â  ss: { color: "bg-orange-500", label: "SS" },â€¨Â  nav: { color: "bg-red-500", label: "NAV" },â€¨};â€¨â€¨// --- HELPERS ---â€¨const toDateStr = (date) => {â€¨Â  const y = date.getFullYear();â€¨Â  const m = String(date.getMonth() + 1).padStart(2, "0");â€¨Â  const d = String(date.getDate()).padStart(2, "0");â€¨Â  return `${y}-${m}-${d}`;â€¨};â€¨â€¨const calculateShiftCycle = (targetDateStr, refDateStr, cycleArray) => {â€¨Â  if (!refDateStr || !cycleArray) return "L";â€¨Â  const oneDay = 24 * 60 * 60 * 1000;â€¨Â  const refDate = new Date(refDateStr + "T00:00:00Z");â€¨Â  const targetDate = new Date(targetDateStr + "T00:00:00Z");â€¨Â  const diffDays = Math.floor((targetDate - refDate) / oneDay);â€¨Â  let index = diffDays % cycleArray.length;â€¨Â  if (index < 0) index += cycleArray.length;â€¨Â  return cycleArray[index];â€¨};â€¨â€¨const getDatesInRange = (startStr, endStr) => {â€¨Â  const dates = [];â€¨Â  let curr = new Date(startStr + "T00:00:00Z");â€¨Â  const end = new Date(endStr + "T00:00:00Z");â€¨Â  while (curr <= end) {â€¨Â  Â  dates.push(curr.toISOString().split("T")[0]);â€¨Â  Â  curr.setDate(curr.getDate() + 1);â€¨Â  }â€¨Â  return dates;â€¨};â€¨â€¨const isRangeWithin = (rangeDates, startLimit, endLimit) => {â€¨Â  return rangeDates.every((d) => d >= startLimit && d <= endLimit);â€¨};â€¨â€¨const validateSpecialRange = (rangeDates, type) => {â€¨Â  if (!rangeDates || rangeDates.length === 0) return { ok: false, reason: "Selecciona primero el rango." };â€¨â€¨Â  if (type === "nav") {â€¨Â  Â  const windowMatch = NAVIDAD_WINDOWS.find((w) => isRangeWithin(rangeDates, w.start, w.end));â€¨Â  Â  if (!windowMatch) {â€¨Â  Â  Â  return { ok: false, reason: "Navidad solo se puede pedir entre 17/12/2025-12/01/2026 o 17/12/2026-12/01/2027." };â€¨Â  Â  }â€¨Â  Â  if (rangeDates.length > 3) return { ok: false, reason: "MÃ¡ximo 3 dÃ­as de Navidad." };â€¨Â  Â  return { ok: true, reason: "Dentro de ventanas autorizadas." };â€¨Â  }â€¨â€¨Â  if (type === "ss") {â€¨Â  Â  if (!isRangeWithin(rangeDates, SS_RANGE.start, SS_RANGE.end)) {â€¨Â  Â  Â  return { ok: false, reason: "Semana Santa solo estÃ¡ permitida del 10 de marzo de 2026 al 20 de abril de 2027." };â€¨Â  Â  }â€¨Â  Â  if (rangeDates.length > 3) return { ok: false, reason: "Semana Santa mÃ¡ximo 3 dÃ­as." };â€¨Â  Â  return { ok: true, reason: "Dentro del rango autorizado." };â€¨Â  }â€¨â€¨Â  return { ok: true, reason: "" };â€¨};â€¨â€¨// PRIORIDAD VACACIONES / NAV / SS (Quien mÃ¡s tiempo lleva sin disfrutar vacaciones)â€¨const getLastVacationEnd = (requests, userId) => {â€¨Â  const relevant = requestsâ€¨Â  Â  .filter((r) => ["vacation", "nav", "ss"].includes(r.type) && r.userId === userId && r.endDate)â€¨Â  Â  .map((r) => r.endDate)â€¨Â  Â  .sort(); â€¨Â  return relevant.length > 0 ? relevant[relevant.length - 1] : "1900-01-01";â€¨};â€¨â€¨// PRIORIDAD AP (Quien mÃ¡s tiempo lleva sin disfrutar AP)â€¨const getLastAPEnd = (requests, userId) => {â€¨Â  const relevant = requestsâ€¨Â  Â  .filter((r) => r.type === "ap" && r.userId === userId && r.endDate)â€¨Â  Â  .map((r) => r.endDate)â€¨Â  Â  .sort(); â€¨Â  return relevant.length > 0 ? relevant[relevant.length - 1] : "1900-01-01";â€¨};â€¨â€¨// --- COMPONENTE CALCULADORA ---â€¨const CalculatorView = ({ onBack }) => {â€¨Â  Â  const [mode, setMode] = useState("vacation"); // vacation | apâ€¨Â  Â  const [hours, setHours] = useState("");â€¨Â  Â  const [shiftLength, setShiftLength] = useState(8);â€¨Â  Â  const [result, setResult] = useState(null);â€¨â€¨Â  Â  const calculate = () => {â€¨Â  Â  Â  Â  const h = parseFloat(hours);â€¨Â  Â  Â  Â  if (isNaN(h)) { setResult("Error"); return; }â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  // FÃ³rmula Corregida Simplificada: horas / turnoâ€¨Â  Â  Â  Â  // Y redondeo hacia arriba en AMBOS casosâ€¨Â  Â  Â  Â  let val = h / shiftLength;â€¨Â  Â  Â  Â  val = Math.ceil(val);â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  setResult(val);â€¨Â  Â  };â€¨â€¨Â  Â  return (â€¨Â  Â  Â  Â  <div className="min-h-screen bg-green-50/30 flex flex-col items-center p-4 font-sans">â€¨Â  Â  Â  Â  Â  Â  <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-green-200 p-6">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={onBack} className="flex items-center gap-2 text-slate-500 font-bold text-sm mb-6 hover:text-slate-800">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ChevronLeft className="w-4 h-4" /> Volverâ€¨Â  Â  Â  Â  Â  Â  Â  Â  </button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h2 className="text-2xl font-black text-green-900 mb-6 flex items-center gap-2">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Calculator className="w-6 h-6" /> Calculadoraâ€¨Â  Â  Â  Â  Â  Â  Â  Â  </h2>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex bg-slate-100 rounded-lg p-1 mb-6">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => {setMode("vacation"); setResult(null);}} className={`flex-1 py-2 rounded-md font-bold text-sm transition-all ${mode === "vacation" ? "bg-white text-emerald-700 shadow" : "text-slate-500"}`}>Vacaciones</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => {setMode("ap"); setResult(null);}} className={`flex-1 py-2 rounded-md font-bold text-sm transition-all ${mode === "ap" ? "bg-white text-purple-700 shadow" : "text-slate-500"}`}>Asuntos Propios</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Horas de crÃ©dito</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" value={hours} onChange={(e) => setHours(e.target.value)} className="w-full p-3 border rounded-xl font-bold text-lg" placeholder="0" />â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">DuraciÃ³n Turno</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select value={shiftLength} onChange={(e) => setShiftLength(parseFloat(e.target.value))} className="w-full p-3 border rounded-xl font-bold text-slate-700 bg-white">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value={8}>8 horas</option>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value={8.5}>8.5 horas</option>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value={12}>12 horas</option>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={calculate} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg ${mode === "vacation" ? "bg-emerald-600 hover:bg-emerald-700" : "bg-purple-600 hover:bg-purple-700"}`}>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Calcular DÃ­asâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {result !== null && (â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="mt-6 text-center animate-in fade-in zoom-in">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">Resultado</span>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className={`text-5xl font-black mt-2 ${mode === "vacation" ? "text-emerald-600" : "text-purple-600"}`}>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {result} <span className="text-xl text-slate-400">dÃ­as</span>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-xs text-slate-400 mt-2 font-medium">(Redondeado hacia arriba)</p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  );â€¨};â€¨â€¨export default function AppFinal() {â€¨Â  const [user, setUser] = useState(null);â€¨Â  const [view, setView] = useState("categories");â€¨Â  const [selectedCategory, setSelectedCategory] = useState(null);â€¨Â  const [selectedUnit, setSelectedUnit] = useState(null);â€¨Â  const [selectedGroupId, setSelectedGroupId] = useState(null);â€¨Â  const [currentUser, setCurrentUser] = useState(null);â€¨Â  const [isAdmin, setIsAdmin] = useState(false);â€¨â€¨Â  const [requests, setRequests] = useState([]);â€¨Â  const [overrides, setOverrides] = useState([]);â€¨Â  const [userSettings, setUserSettings] = useState({});â€¨Â  const [messages, setMessages] = useState([]);â€¨Â  const [loading, setLoading] = useState(true);â€¨â€¨Â  const [loginMember, setLoginMember] = useState(null);â€¨Â  const [pinInput, setPinInput] = useState("");â€¨Â  const [loginError, setLoginError] = useState("");â€¨Â  const [showChat, setShowChat] = useState(false);â€¨Â  const [newMessage, setNewMessage] = useState("");â€¨â€¨Â  const [unreadCount, setUnreadCount] = useState(0);â€¨Â  const lastReadCount = useRef(0);â€¨Â  const chatEndRef = useRef(null);â€¨â€¨Â  const [selectionStart, setSelectionStart] = useState(null);â€¨Â  const [selectionEnd, setSelectionEnd] = useState(null);â€¨Â  const [hoverDate, setHoverDate] = useState(null);â€¨Â  const [showModal, setShowModal] = useState(false);â€¨Â  const [modalError, setModalError] = useState("");â€¨Â  const [selectedRequestToDelete, setSelectedRequestToDelete] = useState(null);â€¨Â  const [selectedOverrideToDelete, setSelectedOverrideToDelete] = useState(null);â€¨â€¨Â  const [showSettingsModal, setShowSettingsModal] = useState(false);â€¨Â  const [tempSettings, setTempSettings] = useState({â€¨Â  Â  ap25: AP_LIMIT_2025_DEFAULT, vac25: VACATION_LIMIT_2025_DEFAULT,â€¨Â  Â  ap26: AP_LIMIT_2026, vac26: VACATION_LIMIT_2026,â€¨Â  });â€¨Â  const [newPin, setNewPin] = useState("");â€¨â€¨Â  const [showYearSelector, setShowYearSelector] = useState(false);â€¨Â  const [pendingRequestType, setPendingRequestType] = useState(null);â€¨â€¨Â  const [showServiceModal, setShowServiceModal] = useState(false);â€¨Â  const [serviceData, setServiceData] = useState({ moto: { M: [], T: [], N: [] }, eis: { M: [], T: [], N: [] } });â€¨Â  const [serviceDate, setServiceDate] = useState("");â€¨â€¨Â  const [showShiftChange, setShowShiftChange] = useState(false);â€¨Â  const [swapTargetShift, setSwapTargetShift] = useState("M");â€¨â€¨Â  const currentMonthRef = useRef(null);â€¨â€¨Â  const unitsInCategory = useMemo(() => {â€¨Â  Â  if (!selectedCategory) return [];â€¨Â  Â  const units = GROUPS.filter((g) => g.category === selectedCategory).map((g) => g.unit);â€¨Â  Â  return [...new Set(units)].sort();â€¨Â  }, [selectedCategory]);â€¨â€¨Â  const groupsInSelectedUnit = useMemo(() => {â€¨Â  Â  if (!selectedUnit) return [];â€¨Â  Â  return GROUPS.filter((g) => g.unit === selectedUnit);â€¨Â  }, [selectedUnit]);â€¨â€¨Â  const activeMembers = useMemo(() => {â€¨Â  Â  if (!selectedGroupId) return [];â€¨Â  Â  return MEMBERS.filter((m) => m.group === selectedGroupId);â€¨Â  }, [selectedGroupId]);â€¨â€¨Â  const occupationMap = useMemo(() => {â€¨Â  Â  const map = {};â€¨Â  Â  const activeMemberIds = activeMembers.map((m) => m.id);â€¨Â  Â  requests.forEach((req) => {â€¨Â  Â  Â  if (activeMemberIds.includes(req.userId)) {â€¨Â  Â  Â  Â  req.days.forEach((day) => {â€¨Â  Â  Â  Â  Â  if (!map[day]) map[day] = { vacation: 0, ap: 0, baja: 0, ss: 0, nav: 0, totalAbsence: 0, reqs: [] };â€¨Â  Â  Â  Â  Â  const type = req.type || "vacation";â€¨Â  Â  Â  Â  Â  map[day][type] = (map[day][type] || 0) + 1;â€¨Â  Â  Â  Â  Â  map[day].totalAbsence++;â€¨Â  Â  Â  Â  Â  map[day].reqs.push(req);â€¨Â  Â  Â  Â  });â€¨Â  Â  Â  }â€¨Â  Â  });â€¨Â  Â  return map;â€¨Â  }, [requests, activeMembers]);â€¨â€¨Â  const overrideMarkedDates = useMemo(() => {â€¨Â  Â  const set = new Set();â€¨Â  Â  overrides.forEach((o) => {â€¨Â  Â  Â  if (currentUser && o.userId === currentUser.id && ["swap", "service"].includes(o.type)) {â€¨Â  Â  Â  Â  set.add(o.date);â€¨Â  Â  Â  }â€¨Â  Â  });â€¨Â  Â  return set;â€¨Â  }, [overrides, currentUser]);â€¨â€¨Â  useEffect(() => { signInAnonymously(auth); onAuthStateChanged(auth, setUser); }, []);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (!loading && view === "dashboard" && currentMonthRef.current) {â€¨Â  Â  Â  currentMonthRef.current.scrollIntoView({ behavior: "smooth", block: "center" });â€¨Â  Â  }â€¨Â  }, [loading, view]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (!user) return;â€¨Â  Â  const unsub = onSnapshot(collection(db, "artifacts", appId, "public", "data", "shift_vacations_v6"), (snap) => {â€¨Â  Â  Â  setRequests(snap.docs.map((d) => ({ id: d.id, ...d.data() }))); setLoading(false);â€¨Â  Â  });â€¨Â  Â  return () => unsub();â€¨Â  }, [user]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (!user) return;â€¨Â  Â  const unsub = onSnapshot(collection(db, "artifacts", appId, "public", "data", "shift_overrides"), (snap) => {â€¨Â  Â  Â  setOverrides(snap.docs.map((d) => ({ id: d.id, ...d.data() })));â€¨Â  Â  });â€¨Â  Â  return () => unsub();â€¨Â  }, [user]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (!user) return;â€¨Â  Â  const unsub = onSnapshot(collection(db, "artifacts", appId, "public", "data", "member_settings"), (snap) => {â€¨Â  Â  Â  const settingsMap = {}; snap.docs.forEach((d) => { settingsMap[d.id] = d.data(); }); setUserSettings(settingsMap);â€¨Â  Â  });â€¨Â  Â  return () => unsub();â€¨Â  }, [user]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (!user || !selectedGroupId) return;â€¨Â  Â  const unsub = onSnapshot(query(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), where("groupId", "==", selectedGroupId)), (snap) => {â€¨Â  Â  Â  const msgs = snap.docs.map((d) => ({ id: d.id, ...d.data() })).sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));â€¨Â  Â  Â  setMessages(msgs); setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);â€¨Â  Â  });â€¨Â  Â  return () => unsub();â€¨Â  }, [user, selectedGroupId]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (showChat) { setUnreadCount(0); lastReadCount.current = messages.length; }â€¨Â  Â  else { const newMsgs = messages.length - lastReadCount.current; if (newMsgs > 0) setUnreadCount(newMsgs); }â€¨Â  }, [messages, showChat]);â€¨â€¨Â  useEffect(() => {â€¨Â  Â  if (showSettingsModal && currentUser) {â€¨Â  Â  Â  const currentLimits = getUserLimits(currentUser.id);â€¨Â  Â  Â  setTempSettings(currentLimits);â€¨Â  Â  Â  setNewPin("");â€¨Â  Â  }â€¨Â  }, [showSettingsModal, currentUser]);â€¨â€¨Â  const getEffectiveShift = (dateStr, userId, groupId) => {â€¨Â  Â  const override = overrides.find((o) => o.userId === userId && o.date === dateStr);â€¨Â  Â  if (override) return override.shift;â€¨Â  Â  const groupConfig = GROUPS.find((g) => g.id === groupId);â€¨Â  Â  if (!groupConfig) return "L";â€¨Â  Â  return calculateShiftCycle(dateStr, groupConfig.refDate, groupConfig.cycle);â€¨Â  };â€¨â€¨Â  const selectionStats = useMemo(() => {â€¨Â  Â  if (!selectionStart) return null;â€¨Â  Â  const start = new Date(selectionStart + "T00:00:00");â€¨Â  Â  const end = selectionEnd ? new Date(selectionEnd + "T00:00:00") : start;â€¨Â  Â  const [from, to] = start <= end ? [start, end] : [end, start];â€¨Â  Â  const startStr = toDateStr(from);â€¨Â  Â  const endStr = toDateStr(to);â€¨Â  Â  const range = getDatesInRange(startStr, endStr);â€¨Â  Â  const workDays = range.reduce((acc, day) => {â€¨Â  Â  Â  const shift = currentUser ? getEffectiveShift(day, currentUser.id, currentUser.group) : "L";â€¨Â  Â  Â  const style = getShiftStyle(shift);â€¨Â  Â  Â  return style.workDay ? acc + 1 : acc;â€¨Â  Â  }, 0);â€¨Â  Â  return { startStr, endStr, range, workDays };â€¨Â  }, [selectionStart, selectionEnd, currentUser, overrides]);â€¨â€¨Â  const openPopup = (url, title) => {â€¨Â  Â  const width = 600, height = 800;â€¨Â  Â  const left = window.screen.width / 2 - width / 2;â€¨Â  Â  const top = window.screen.height / 2 - height / 2;â€¨Â  Â  window.open(url, title, `toolbar=no, location=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=${width}, height=${height}, top=${top}, left=${left}`);â€¨Â  };â€¨â€¨Â  const handleLoginAttempt = (member) => { setLoginMember(member); setPinInput(""); setLoginError(""); };â€¨Â  const handleLogout = () => { setCurrentUser(null); setIsAdmin(false); setLoginMember(null); setSelectionStart(null); setSelectionEnd(null); setShowChat(false); setView("categories"); setSelectedCategory(null); setSelectedUnit(null); setSelectedGroupId(null); };â€¨â€¨Â  const submitPin = (e) => {â€¨Â  Â  e.preventDefault();â€¨Â  Â  const storedSettings = userSettings[loginMember.id] || {};â€¨Â  Â  const realPin = storedSettings.pin || (loginMember.id === "admin" ? DEFAULT_ADMIN_PIN : DEFAULT_USER_PIN);â€¨Â  Â  if (pinInput === realPin) { setCurrentUser(loginMember); setIsAdmin(loginMember.id === "admin"); setLoginMember(null); setView("dashboard"); }â€¨Â  Â  else { setLoginError("PIN Incorrecto"); }â€¨Â  };â€¨â€¨Â  const getUserLimits = (userId) => {â€¨Â  Â  const settings = userSettings[userId] || {};â€¨Â  Â  return {â€¨Â  Â  Â  ap25: settings.ap25 !== undefined ? settings.ap25 : AP_LIMIT_2025_DEFAULT,â€¨Â  Â  Â  vac25: settings.vac25 !== undefined ? settings.vac25 : VACATION_LIMIT_2025_DEFAULT,â€¨Â  Â  Â  ap26: settings.ap26 !== undefined ? settings.ap26 : AP_LIMIT_2026,â€¨Â  Â  Â  vac26: settings.vac26 !== undefined ? settings.vac26 : VACATION_LIMIT_2026,â€¨Â  Â  };â€¨Â  };â€¨â€¨Â  const saveSettings = async () => {â€¨Â  Â  try {â€¨Â  Â  Â  const updateData = { ...tempSettings }; if (newPin && newPin.length === 4) updateData.pin = newPin;â€¨Â  Â  Â  await setDoc(doc(db, "artifacts", appId, "public", "data", "member_settings", currentUser.id), updateData, { merge: true });â€¨Â  Â  Â  if (newPin) alert("Â¡PIN actualizado!"); setShowSettingsModal(false);â€¨Â  Â  } catch (e) { console.error(e); }â€¨Â  };â€¨â€¨Â  const sendMessage = async (e) => {â€¨Â  Â  e.preventDefault(); if (!newMessage.trim()) return;â€¨Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), { text: newMessage, userId: currentUser.id, userName: currentUser.name, groupId: selectedGroupId, createdAt: serverTimestamp() });â€¨Â  Â  setNewMessage("");â€¨Â  };â€¨â€¨Â  const calculateService = (date) => {â€¨Â  Â  const shifts = { moto: { M: [], T: [], N: [] }, eis: { M: [], T: [], N: [] } };â€¨Â  Â  MEMBERS.forEach((member) => {â€¨Â  Â  Â  if (member.active) {â€¨Â  Â  Â  Â  const memberGroup = GROUPS.find((g) => g.id === member.group);â€¨Â  Â  Â  Â  if (memberGroup) {â€¨Â  Â  Â  Â  Â  const isAbsent = requests.some((r) => r.userId === member.id && r.days.includes(date));â€¨Â  Â  Â  Â  Â  if (!isAbsent) {â€¨Â  Â  Â  Â  Â  Â  const shift = getEffectiveShift(date, member.id, member.group);â€¨Â  Â  Â  Â  Â  Â  if (["M", "T", "N"].includes(shift)) {â€¨Â  Â  Â  Â  Â  Â  Â  const displayInfo = `${member.name} (${memberGroup.unit.replace("Destacamento ", "").replace("EIS ", "")})`;â€¨Â  Â  Â  Â  Â  Â  Â  if (memberGroup.category === "motoristas") shifts.moto[shift].push(displayInfo); else shifts.eis[shift].push(displayInfo);â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  }â€¨Â  Â  });â€¨Â  Â  setServiceData(shifts); setServiceDate(date); setShowServiceModal(true);â€¨Â  };â€¨â€¨Â  // âœ… FUNCIONALIDAD PRINCIPAL: VerificaciÃ³n de cupos y prioridadesâ€¨Â  const checkPreferenceAndDisplace = async (type) => {â€¨Â  Â  // 1. BAJAS no tienen lÃ­miteâ€¨Â  Â  if (type === "baja") return { allowed: true };â€¨â€¨Â  Â  const displacements = new Set();â€¨Â  Â  const myLastVacation = getLastVacationEnd(requests, currentUser.id);â€¨Â  Â  const myLastAP = getLastAPEnd(requests, currentUser.id);â€¨â€¨Â  Â  // Iteramos dÃ­a por dÃ­a para validar cupos independientesâ€¨Â  Â  for (const day of selectionStats.range) {â€¨Â  Â  Â  // Filtrar solicitudes del mismo grupo en ese dÃ­aâ€¨Â  Â  Â  const groupRequests = requests.filter((r) => {â€¨Â  Â  Â  Â  const member = MEMBERS.find((m) => m.id === r.userId);â€¨Â  Â  Â  Â  return member && member.group === currentUser.group && r.days.includes(day);â€¨Â  Â  Â  });â€¨â€¨Â  Â  Â  // --- LOGICA VACACIONES / NAVIDAD / SS (Cupos fijos, Independientes) ---â€¨Â  Â  Â  if (["vacation", "nav", "ss"].includes(type)) {â€¨Â  Â  Â  Â  // Filtrar solo las de ESTE tipo especÃ­fico (Independencia de cupos)â€¨Â  Â  Â  Â  const specificRequests = groupRequests.filter(r => r.type === type);â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  // LÃ­mite fijado en constantesâ€¨Â  Â  Â  Â  const limit = type === "vacation" ? MAX_VACATION_PER_GROUP : MAX_SPECIAL_PER_GROUP;â€¨â€¨Â  Â  Â  Â  if (specificRequests.length >= limit) {â€¨Â  Â  Â  Â  Â  // Ordenar por prioridad (quien tiene la fecha mÃ¡s reciente de vacaciones = menos prioridad)â€¨Â  Â  Â  Â  Â  const ranked = specificRequestsâ€¨Â  Â  Â  Â  Â  Â  .map((r) => ({ req: r, last: getLastVacationEnd(requests, r.userId) }))â€¨Â  Â  Â  Â  Â  Â  .sort((a, b) => b.last.localeCompare(a.last));â€¨â€¨Â  Â  Â  Â  Â  const leastPreferred = ranked[0];â€¨â€¨Â  Â  Â  Â  Â  // Si mi Ãºltima fecha es ANTERIOR a la suya, tengo preferenciaâ€¨Â  Â  Â  Â  Â  if (myLastVacation < leastPreferred.last) {â€¨Â  Â  Â  Â  Â  Â  displacements.add(leastPreferred.req.id);â€¨Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  return { allowed: false, msg: `Cupo de ${type.toUpperCase()} completo el dÃ­a ${day} y no tienes preferencia.` };â€¨Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  }â€¨â€¨Â  Â  Â  // --- LOGICA ASUNTOS PROPIOS (AP) (Depende de personal disponible) ---â€¨Â  Â  Â  if (type === "ap") {â€¨Â  Â  Â  Â  // Calcular cuÃ¡ntos miembros activos tiene el grupoâ€¨Â  Â  Â  Â  const totalMembers = activeMembers.filter(m => m.active).length;â€¨Â  Â  Â  Â  // Calcular cuÃ¡ntos faltan ese dÃ­a por CUALQUIER motivoâ€¨Â  Â  Â  Â  const absentCount = groupRequests.length;â€¨Â  Â  Â  Â  // Personal disponible si se aprueba mi solicitud (+1 ausencia)â€¨Â  Â  Â  Â  const remainingStaff = totalMembers - (absentCount + 1);â€¨â€¨Â  Â  Â  Â  if (remainingStaff < MIN_WORKING_STAFF_FOR_AP) {â€¨Â  Â  Â  Â  Â  // Cupo lleno por falta de personal.â€¨Â  Â  Â  Â  Â  // Solo podemos desplazar a OTROS APs (Cupos no se cruzan: no puedo quitar vacaciones)â€¨Â  Â  Â  Â  Â  const apRequests = groupRequests.filter(r => r.type === "ap");â€¨â€¨Â  Â  Â  Â  Â  if (apRequests.length > 0) {â€¨Â  Â  Â  Â  Â  Â  // Buscar el AP con menos prioridad (fecha mÃ¡s reciente de disfrute)â€¨Â  Â  Â  Â  Â  Â  const rankedAPs = apRequestsâ€¨Â  Â  Â  Â  Â  Â  Â  .map(r => ({ req: r, last: getLastAPEnd(requests, r.userId) }))â€¨Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b.last.localeCompare(a.last));â€¨Â  Â  Â  Â  Â  Â  â€¨Â  Â  Â  Â  Â  Â  const leastPreferredAP = rankedAPs[0];â€¨â€¨Â  Â  Â  Â  Â  Â  if (myLastAP < leastPreferredAP.last) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  displacements.add(leastPreferredAP.req.id);â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  return { allowed: false, msg: `No hay cupo de AP el dÃ­a ${day} (faltarÃ­a personal) y no tienes preferencia sobre los APs existentes.` };â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  // Si no hay APs para desplazar (las ausencias son vacaciones/bajas), no puedo hacer nada.â€¨Â  Â  Â  Â  Â  Â  return { allowed: false, msg: `No hay cupo de AP el dÃ­a ${day}. Faltan efectivos por otros motivos (Vacaciones/Bajas) y no se pueden desplazar.` };â€¨Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  }â€¨Â  Â  }â€¨â€¨Â  Â  return { allowed: true, displacements: [...displacements] };â€¨Â  };â€¨â€¨Â  const processRequest = async (type, yearToCharge) => {â€¨Â  Â  if (!currentUser || !selectionStats) return;â€¨â€¨Â  Â  if (type === "nav" || type === "ss") {â€¨Â  Â  Â  const validation = validateSpecialRange(selectionStats.range, type);â€¨Â  Â  Â  if (!validation.ok) { setModalError(validation.reason); return; }â€¨Â  Â  }â€¨â€¨Â  Â  const limits = getUserLimits(currentUser.id);â€¨Â  Â  if (type === "vacation") {â€¨Â  Â  Â  const limit = yearToCharge === "2025" ? limits.vac25 : limits.vac26;â€¨Â  Â  Â  const used = getUsed(currentUser.id, "vacation", yearToCharge);â€¨Â  Â  Â  if (used + selectionStats.workDays > limit) { setModalError(`Superas el lÃ­mite de ${yearToCharge}.`); return; }â€¨Â  Â  } else if (type === "ap") {â€¨Â  Â  Â  const limit = yearToCharge === "2025" ? limits.ap25 : limits.ap26;â€¨Â  Â  Â  const used = getUsed(currentUser.id, "ap", yearToCharge);â€¨Â  Â  Â  if (used + selectionStats.workDays > limit) { setModalError(`Superas el lÃ­mite de ${yearToCharge}.`); return; }â€¨Â  Â  }â€¨â€¨Â  Â  const checkResult = await checkPreferenceAndDisplace(type);â€¨Â  Â  â€¨Â  Â  if (!checkResult.allowed) { â€¨Â  Â  Â  setModalError(checkResult.msg); â€¨Â  Â  Â  return; â€¨Â  Â  }â€¨â€¨Â  Â  if (checkResult.displacements?.length) {â€¨Â  Â  Â  const confirmDisplace = confirm("âš ï¸ AVISO DE PRIORIDAD\n\nEl cupo estÃ¡ lleno, pero tienes preferencia sobre una solicitud existente.\n\nÂ¿Quieres DESPLAZAR al compaÃ±ero con menor prioridad?");â€¨Â  Â  Â  if (!confirmDisplace) { â€¨Â  Â  Â  Â  setModalError("Solicitud cancelada."); â€¨Â  Â  Â  Â  return; â€¨Â  Â  Â  }â€¨Â  Â  Â  â€¨Â  Â  Â  try {â€¨Â  Â  Â  Â  for (const reqId of checkResult.displacements) {â€¨Â  Â  Â  Â  Â  await deleteDoc(doc(db, "artifacts", appId, "public", "data", "shift_vacations_v6", reqId));â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), { â€¨Â  Â  Â  Â  Â  Â  text: `âš ï¸ SISTEMA: ${currentUser.name} ha ejercido su derecho de prioridad, desplazando una solicitud de ${type.toUpperCase()}.`, â€¨Â  Â  Â  Â  Â  Â  userId: "system", â€¨Â  Â  Â  Â  Â  Â  userName: "âš–ï¸ PRIORIDAD", â€¨Â  Â  Â  Â  Â  Â  groupId: currentUser.group, â€¨Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp() â€¨Â  Â  Â  Â  });â€¨Â  Â  Â  } catch(e) {â€¨Â  Â  Â  Â  console.error(e);â€¨Â  Â  Â  Â  setModalError("Error al procesar el desplazamiento.");â€¨Â  Â  Â  Â  return;â€¨Â  Â  Â  }â€¨Â  Â  }â€¨â€¨Â  Â  try {â€¨Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_vacations_v6"), {â€¨Â  Â  Â  Â  userId: currentUser.id, userName: currentUser.name, type: type, year: yearToCharge,â€¨Â  Â  Â  Â  startDate: selectionStats.startStr, endDate: selectionStats.endStr, days: selectionStats.range,â€¨Â  Â  Â  Â  cost: selectionStats.workDays, createdAt: serverTimestamp(),â€¨Â  Â  Â  });â€¨Â  Â  Â  alert("âœ… Solicitud guardada correctamente"); closeAllModals();â€¨Â  Â  } catch (e) { alert("âŒ Error al guardar: " + e.message); setModalError("Error guardando."); }â€¨Â  };â€¨â€¨Â  // âœ… CORREGIDO: Delete Request con Try/Catch para evitar congelamientoâ€¨Â  const deleteRequest = async () => {â€¨Â  Â  if (!selectedRequestToDelete || !selectedRequestToDelete.id) return;â€¨Â  Â  â€¨Â  Â  if (confirm("Â¿EstÃ¡s seguro de borrar esta solicitud?")) {â€¨Â  Â  Â  try {â€¨Â  Â  Â  Â  await deleteDoc(doc(db, "artifacts", appId, "public", "data", "shift_vacations_v6", selectedRequestToDelete.id));â€¨Â  Â  Â  Â  alert("Solicitud eliminada.");â€¨Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  console.error("Error eliminando:", error);â€¨Â  Â  Â  Â  alert("Hubo un error al eliminar la solicitud. IntÃ©ntalo de nuevo.");â€¨Â  Â  Â  } finally {â€¨Â  Â  Â  Â  closeAllModals();â€¨Â  Â  Â  }â€¨Â  Â  }â€¨Â  };â€¨â€¨Â  const deleteOverride = async () => {â€¨Â  Â  if (!selectedOverrideToDelete) return;â€¨Â  Â  if (confirm("Â¿Restaurar turno original?")) {â€¨Â  Â  Â  try {â€¨Â  Â  Â  Â  await deleteDoc(doc(db, "artifacts", appId, "public", "data", "shift_overrides", selectedOverrideToDelete.id));â€¨Â  Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), { text: `âš ï¸ AVISO: ${currentUser.name} ha anulado su cambio de servicio del dÃ­a ${selectedOverrideToDelete.date}.`, userId: "system", userName: "â†©ï¸ CAMBIO ANULADO", groupId: currentUser.group, createdAt: serverTimestamp() });â€¨Â  Â  Â  } catch (e) {â€¨Â  Â  Â  Â  console.error(e);â€¨Â  Â  Â  } finally {â€¨Â  Â  Â  Â  closeAllModals();â€¨Â  Â  Â  }â€¨Â  Â  }â€¨Â  };â€¨â€¨Â  // âœ… REGLA 2: Solicitud de cambio de turno en Chatâ€¨Â  const requestSwap = async (targetShift) => {â€¨Â  Â  const dateStr = selectionStart;â€¨Â  Â  if (!dateStr) return;â€¨Â  Â  â€¨Â  Â  const myGroupConfig = GROUPS.find((g) => g.id === currentUser.group);â€¨Â  Â  const targetGroups = [];â€¨Â  Â  â€¨Â  Â  GROUPS.forEach((g) => {â€¨Â  Â  Â  if (g.unit === myGroupConfig.unit) {â€¨Â  Â  Â  Â  const s = calculateShiftCycle(dateStr, g.refDate, g.cycle);â€¨Â  Â  Â  Â  if (s === targetShift) targetGroups.push(g.id);â€¨Â  Â  Â  }â€¨Â  Â  });â€¨â€¨Â  Â  if (targetGroups.length === 0) { â€¨Â  Â  Â  Â  alert("NingÃºn grupo de tu unidad tiene ese turno hoy por cuadrante."); â€¨Â  Â  Â  Â  return; â€¨Â  Â  }â€¨â€¨Â  Â  const myCurrentShift = getEffectiveShift(dateStr, currentUser.id, currentUser.group);â€¨Â  Â  â€¨Â  Â  const swapData = { â€¨Â  Â  Â  Â  type: "swap_request", â€¨Â  Â  Â  Â  requesterId: currentUser.id, â€¨Â  Â  Â  Â  requesterName: currentUser.name, â€¨Â  Â  Â  Â  date: dateStr, â€¨Â  Â  Â  Â  fromShift: myCurrentShift, â€¨Â  Â  Â  Â  toShift: targetShift, â€¨Â  Â  Â  Â  status: "pending", â€¨Â  Â  Â  Â  requesterGroupId: currentUser.group â€¨Â  Â  };â€¨â€¨Â  Â  for (const gid of targetGroups) {â€¨Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), { â€¨Â  Â  Â  Â  Â  text: `ğŸ”„ SOLICITUD DE CAMBIO: ${currentUser.name} tiene ${myCurrentShift} el dÃ­a ${dateStr} y busca ${targetShift}.`, â€¨Â  Â  Â  Â  Â  userId: "system", â€¨Â  Â  Â  Â  Â  userName: "ğŸ“¢ CAMBIO SERVICIO", â€¨Â  Â  Â  Â  Â  groupId: gid, â€¨Â  Â  Â  Â  Â  isSwap: true, â€¨Â  Â  Â  Â  Â  swapData: swapData, â€¨Â  Â  Â  Â  Â  createdAt: serverTimestamp() â€¨Â  Â  Â  });â€¨Â  Â  }â€¨â€¨Â  Â  alert("Solicitud enviada al chat de los compaÃ±eros que trabajan ese dÃ­a."); â€¨Â  Â  closeAllModals();â€¨Â  };â€¨â€¨Â  // âœ… CORREGIDO: Aceptar cambio con Try/Catch y mejor feedbackâ€¨Â  const acceptSwap = async (msg) => {â€¨Â  Â  if (msg.swapData.status !== "pending") return;â€¨Â  Â  if (msg.swapData.requesterId === currentUser.id) { alert("No puedes aceptar tu propio cambio."); return; }â€¨Â  Â  â€¨Â  Â  if (!confirm(`Â¿Aceptas cambiar tu turno con ${msg.swapData.requesterName} el dÃ­a ${msg.swapData.date}?`)) return;â€¨â€¨Â  Â  try {â€¨Â  Â  Â  // 1. Crear overrides para AMBOSâ€¨Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_overrides"), { â€¨Â  Â  Â  Â  Â  userId: msg.swapData.requesterId, â€¨Â  Â  Â  Â  Â  date: msg.swapData.date, â€¨Â  Â  Â  Â  Â  shift: msg.swapData.toShift,â€¨Â  Â  Â  Â  Â  type: "swap", â€¨Â  Â  Â  Â  Â  createdAt: serverTimestamp() â€¨Â  Â  Â  });â€¨â€¨Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_overrides"), { â€¨Â  Â  Â  Â  Â  userId: currentUser.id, â€¨Â  Â  Â  Â  Â  date: msg.swapData.date, â€¨Â  Â  Â  Â  Â  shift: msg.swapData.fromShift,â€¨Â  Â  Â  Â  Â  type: "swap", â€¨Â  Â  Â  Â  Â  createdAt: serverTimestamp() â€¨Â  Â  Â  });â€¨â€¨Â  Â  Â  // 2. Actualizar estado del mensajeâ€¨Â  Â  Â  await updateDoc(doc(db, "artifacts", appId, "public", "data", "shift_chat_messages", msg.id), { â€¨Â  Â  Â  Â  Â  "swapData.status": "accepted", â€¨Â  Â  Â  Â  Â  "swapData.acceptedBy": currentUser.name â€¨Â  Â  Â  });â€¨â€¨Â  Â  Â  // 3. NotificaciÃ³n de confirmaciÃ³nâ€¨Â  Â  Â  if (msg.swapData.requesterGroupId && msg.swapData.requesterGroupId !== currentUser.group) {â€¨Â  Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_chat_messages"), { â€¨Â  Â  Â  Â  Â  Â  text: `âœ… CAMBIO CONFIRMADO: ${currentUser.name} ha aceptado el cambio de turno de ${msg.swapData.requesterName} para el dÃ­a ${msg.swapData.date}.`, â€¨Â  Â  Â  Â  Â  Â  userId: "system", â€¨Â  Â  Â  Â  Â  Â  userName: "âœ… CAMBIO REALIZADO", â€¨Â  Â  Â  Â  Â  Â  groupId: msg.swapData.requesterGroupId, â€¨Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp() â€¨Â  Â  Â  Â  });â€¨Â  Â  Â  }â€¨Â  Â  Â  â€¨Â  Â  Â  alert("Â¡Cambio realizado correctamente! El cuadrante se ha actualizado.");â€¨Â  Â  } catch (error) {â€¨Â  Â  Â  console.error("Error al aceptar cambio:", error);â€¨Â  Â  Â  alert("Error al procesar el cambio. IntÃ©ntalo de nuevo.");â€¨Â  Â  }â€¨Â  };â€¨â€¨Â  const applyServiceChange = async (newShift) => {â€¨Â  Â  const dateStr = selectionStart; if (!dateStr) return;â€¨Â  Â  try {â€¨Â  Â  Â  Â  await addDoc(collection(db, "artifacts", appId, "public", "data", "shift_overrides"), { userId: currentUser.id, date: dateStr, shift: newShift, type: "service", createdAt: serverTimestamp() });â€¨Â  Â  } catch(e) { console.error(e); }â€¨Â  Â  finally { closeAllModals(); }â€¨Â  };â€¨â€¨Â  const closeAllModals = () => {â€¨Â  Â  setSelectionStart(null); setSelectionEnd(null); setShowModal(false); setShowYearSelector(false); setShowShiftChange(false); setModalError(""); setSelectedRequestToDelete(null); setSelectedOverrideToDelete(null);â€¨Â  };â€¨â€¨Â  const getUsed = (uid, type, year) => requests.filter((r) => r.userId === uid && r.type === type && r.year === year).reduce((acc, r) => acc + r.cost, 0);â€¨â€¨Â  // --- RENDER ---â€¨Â  const renderDay = useCallback((year, month, d) => {â€¨Â  Â  const date = new Date(year, month, d);â€¨Â  Â  const dateStr = toDateStr(date);â€¨Â  Â  const isToday = dateStr === toDateStr(new Date());â€¨Â  Â  const shift = getEffectiveShift(dateStr, currentUser?.id, currentUser?.group);â€¨Â  Â  â€¨Â  Â  // Usamos la nueva funciÃ³n helper para soportar servicios especialesâ€¨Â  Â  const style = getShiftStyle(shift);â€¨Â  Â  â€¨Â  Â  const occ = occupationMap[dateStr];â€¨Â  Â  let isSelected = selectionStats && selectionStats.range.includes(dateStr);â€¨Â  Â  const isInteractive = dateStr >= PERIOD_START && dateStr <= PERIOD_END;â€¨Â  Â  â€¨Â  Â  // âœ… REGLA 2: Solo yo veo mis cambiosâ€¨Â  Â  const isOverrideDay = overrideMarkedDates.has(dateStr);â€¨â€¨Â  Â  let bgClass = isSelected ? "bg-green-100 ring-2 ring-green-600 z-10" : "hover:bg-green-50/30";â€¨Â  Â  if (isToday && !isSelected) bgClass = "bg-yellow-200/60 ring-2 ring-yellow-400";â€¨â€¨Â  Â  return (â€¨Â  Â  Â  <divâ€¨Â  Â  Â  Â  key={dateStr}â€¨Â  Â  Â  Â  onClick={() => isInteractive && handleDayClick(dateStr)}â€¨Â  Â  Â  Â  className={`relative h-auto min-h-[5.5rem] border-green-100 border-r border-b p-1 cursor-pointer select-none flex flex-col ${bgClass} ${â€¨Â  Â  Â  Â  Â  !isInteractive ? "opacity-40 pointer-events-none bg-gray-50" : "bg-white/80"â€¨Â  Â  Â  Â  } ${isOverrideDay ? "ring-2 ring-red-500 border-red-300" : ""}`} // Borde rojo si es overrideâ€¨Â  Â  Â  >â€¨Â  Â  Â  Â  <div className="flex justify-between items-start mb-1">â€¨Â  Â  Â  Â  Â  <span className={`text-xs font-bold ${[0, 6].includes(date.getDay()) ? "text-red-400" : "text-green-800"}`}>{d}</span>â€¨Â  Â  Â  Â  Â  <span className={`text-[9px] font-bold px-1 rounded border ${style.bg} ${style.text}`} title={style.fullLabel || style.label}>â€¨Â  Â  Â  Â  Â  Â  {style.label}â€¨Â  Â  Â  Â  Â  </span>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  <div className="flex flex-col gap-0.5 mt-1 w-full overflow-hidden">â€¨Â  Â  Â  Â  Â  {occ && occ.reqs.map((req, i) => (â€¨Â  Â  Â  Â  Â  Â  <div key={i} className={`text-[9px] px-1 py-0.5 rounded truncate font-medium text-white shadow-sm ${TYPE_STYLES[req.type || "vacation"]?.color} ${req.userId === currentUser?.id ? "ring-1 ring-yellow-400 z-10 font-bold" : "opacity-90"}`}>{req.userName}</div>â€¨Â  Â  Â  Â  Â  ))}â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  </div>â€¨Â  Â  );â€¨Â  }, [currentUser, occupationMap, selectionStats, overrides, overrideMarkedDates]);â€¨â€¨Â  // Calendar Grid Logicâ€¨Â  const calendarGrid = useMemo(() => {â€¨Â  Â  const grids = []; let curr = new Date(PERIOD_START); const end = new Date(PERIOD_END); curr.setDate(1);â€¨Â  Â  const today = new Date(); const currentYear = today.getFullYear(); const currentMonth = today.getMonth();â€¨Â  Â  while (curr <= end) {â€¨Â  Â  Â  const year = curr.getFullYear(); const month = curr.getMonth(); const days = [];â€¨Â  Â  Â  const daysInMonth = new Date(year, month + 1, 0).getDate();â€¨Â  Â  Â  const offset = (new Date(year, month, 1).getDay() + 6) % 7;â€¨Â  Â  Â  for (let i = 0; i < offset; i++) days.push(<div key={`e-${i}`} className="bg-green-50/20 border-r border-b border-green-100" />);â€¨Â  Â  Â  for (let d = 1; d <= daysInMonth; d++) days.push(renderDay(year, month, d));â€¨Â  Â  Â  const isCurrentMonthGrid = year === currentYear && month === currentMonth;â€¨Â  Â  Â  grids.push(â€¨Â  Â  Â  Â  <div key={`${year}-${month}`} ref={isCurrentMonthGrid ? currentMonthRef : null} className="break-inside-avoid mb-6 bg-white shadow-sm border border-green-200 rounded-lg overflow-hidden">â€¨Â  Â  Â  Â  Â  <div className="bg-green-900 text-white px-4 py-2 font-bold text-sm flex justify-between"><span>{curr.toLocaleDateString("es-ES", { month: "long", year: "numeric" }).toUpperCase()}</span></div>â€¨Â  Â  Â  Â  Â  <div className="grid grid-cols-7 text-center bg-green-50 text-[10px] font-bold text-green-800 py-1 border-b border-green-200"><div>LUN</div><div>MAR</div><div>MIÃ‰</div><div>JUE</div><div>VIE</div><div className="text-red-400">SÃB</div><div className="text-red-400">DOM</div></div>â€¨Â  Â  Â  Â  Â  <div className="grid grid-cols-7">{days}</div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  );â€¨Â  Â  Â  curr.setMonth(curr.getMonth() + 1);â€¨Â  Â  }â€¨Â  Â  return grids;â€¨Â  }, [renderDay, requests, selectionStart, selectionEnd, currentUser, overrides, selectedGroupId, occupationMap]);â€¨â€¨Â  // Click Handlerâ€¨Â  const handleDayClick = (dateStr) => {â€¨Â  Â  if (dateStr < PERIOD_START || dateStr > PERIOD_END) return;â€¨Â  Â  const myOverride = overrides.find((o) => o.userId === currentUser.id && o.date === dateStr);â€¨Â  Â  if (myOverride) { setSelectedOverrideToDelete(myOverride); setShowModal(true); setSelectionStart(dateStr); setSelectionEnd(null); return; }â€¨Â  Â  const myReq = requests.find((r) => r.userId === currentUser.id && r.days.includes(dateStr));â€¨Â  Â  if (myReq) { setSelectedRequestToDelete(myReq); setShowModal(true); setSelectionStart(null); return; }â€¨Â  Â  if (!selectionStart || (selectionStart && selectionEnd)) { setSelectionStart(dateStr); setSelectionEnd(null); setShowModal(false); }â€¨Â  Â  else { setSelectionEnd(dateStr); setShowModal(true); }â€¨Â  };â€¨â€¨Â  const initiateRequest = (type) => {â€¨Â  Â  if (!selectionStats) return; setModalError("");â€¨Â  Â  const isOverlap = selectionStats.range.every((d) => d >= START_2026_START && d <= LIMIT_2025_END);â€¨Â  Â  if ((type === "vacation" || type === "ap") && isOverlap) { setPendingRequestType(type); setShowYearSelector(true); }â€¨Â  Â  else {â€¨Â  Â  Â  let yearToCharge = "2026";â€¨Â  Â  Â  if (selectionStats.endStr <= LIMIT_2025_END && selectionStats.startStr < START_2026_START) yearToCharge = "2025";â€¨Â  Â  Â  processRequest(type, yearToCharge);â€¨Â  Â  }â€¨Â  };â€¨â€¨Â  const currentDayShift = selectionStart ? getEffectiveShift(selectionStart, currentUser?.id, currentUser?.group) : null;â€¨Â  const isWorkingDay = currentDayShift && getShiftStyle(currentDayShift).workDay;â€¨â€¨Â  // --- VIEWS ---â€¨Â  if (view === "calculator") return <CalculatorView onBack={() => setView("categories")} />;â€¨â€¨Â  if (view === "categories") return (â€¨Â  Â  <div className="min-h-screen bg-green-50/30 flex flex-col items-center justify-center p-4 font-sans relative">â€¨Â  Â  Â  <div className="max-w-md w-full text-center">â€¨Â  Â  Â  Â  <img src={LOGO_URL} className="w-24 h-24 mx-auto mb-6 object-contain bg-white rounded-full p-2 shadow-xl border-4 border-green-100" />â€¨Â  Â  Â  Â  <h1 className="text-3xl font-black text-green-900 mb-2">TRÃFICO APP</h1>â€¨Â  Â  Â  Â  <div className="grid gap-4">â€¨Â  Â  Â  Â  Â  <button onClick={() => { setSelectedCategory("motoristas"); setView("units"); }} className="w-full bg-white p-6 rounded-2xl shadow-md hover:shadow-lg flex items-center gap-4"><Bike className="w-8 h-8 text-emerald-600" /><span className="font-bold text-xl text-green-900">Motoristas</span></button>â€¨Â  Â  Â  Â  Â  <button onClick={() => { setSelectedCategory("atestados"); setView("units"); }} className="w-full bg-white p-6 rounded-2xl shadow-md hover:shadow-lg flex items-center gap-4"><FileText className="w-8 h-8 text-blue-600" /><span className="font-bold text-xl text-blue-900">Atestados</span></button>â€¨Â  Â  Â  Â  Â  {/* âœ… NUEVO BOTÃ“N CALCULADORA */}â€¨Â  Â  Â  Â  Â  <button onClick={() => setView("calculator")} className="w-full bg-white p-6 rounded-2xl shadow-md hover:shadow-lg flex items-center gap-4"><Calculator className="w-8 h-8 text-purple-600" /><span className="font-bold text-xl text-purple-900">Calculadora</span></button>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  <div className="absolute bottom-4 left-0 right-0 text-center">â€¨Â  Â  Â  Â  Â  Â  <span className="text-[10px] font-bold text-green-800/60 uppercase tracking-widest border-t border-green-800/20 pt-2 px-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Autor Gc Escribano Dto Benidormâ€¨Â  Â  Â  Â  Â  Â  </span>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  </div>â€¨Â  Â  </div>â€¨Â  );â€¨â€¨Â  if (view === "units") return (â€¨Â  Â  <div className="min-h-screen bg-green-50/30 flex flex-col items-center justify-center p-4 font-sans relative">â€¨Â  Â  Â  <div className="max-w-md w-full text-center">â€¨Â  Â  Â  Â  <div className="flex items-center justify-between mb-6 px-2"><button onClick={() => setView("categories")} className="p-2 bg-white rounded-full shadow-sm"><ChevronLeft /></button><h2 className="text-xl font-black text-green-900 uppercase">{selectedCategory}</h2><div className="w-10"></div></div>â€¨Â  Â  Â  Â  <div className="space-y-4 max-h-[60vh] overflow-y-auto p-2">{unitsInCategory.map((unitName) => (<button key={unitName} onClick={() => { setSelectedUnit(unitName); setView("groups"); }} className="w-full bg-white p-6 rounded-2xl shadow-md hover:shadow-lg flex justify-between items-center"><span className="font-bold text-lg text-green-900">{unitName}</span><ChevronRight /></button>))}</div>â€¨Â  Â  Â  </div>â€¨Â  Â  </div>â€¨Â  );â€¨â€¨Â  if (view === "groups") return (â€¨Â  Â  <div className="min-h-screen bg-green-50/30 flex flex-col items-center justify-center p-4 font-sans relative">â€¨Â  Â  Â  <div className="max-w-md w-full text-center">â€¨Â  Â  Â  Â  <div className="flex items-center justify-between mb-6 px-2"><button onClick={() => { setSelectedUnit(null); setView("units"); }} className="p-2 bg-white rounded-full shadow-sm"><ChevronLeft /></button><h2 className="text-lg font-black text-green-900 truncate max-w-[220px]">{selectedUnit}</h2><div className="w-10"></div></div>â€¨Â  Â  Â  Â  <div className="space-y-4 max-h-[60vh] overflow-y-auto p-2">{groupsInSelectedUnit.map((g) => (<button key={g.id} onClick={() => { setSelectedGroupId(g.id); setView("login"); }} className="w-full bg-white p-6 rounded-2xl shadow-md hover:shadow-lg flex justify-between items-center"><span className="font-bold text-xl text-green-800">{g.name}</span><ChevronRight /></button>))}</div>â€¨Â  Â  Â  </div>â€¨Â  Â  </div>â€¨Â  );â€¨â€¨Â  if (view === "login" && !currentUser) return (â€¨Â  Â  <div className="min-h-screen bg-green-50/30 flex flex-col items-center justify-center p-4 font-sans">â€¨Â  Â  Â  {!loginMember ? (â€¨Â  Â  Â  Â  <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-green-200">â€¨Â  Â  Â  Â  Â  <div className="bg-green-900 p-6 text-center relative"><button onClick={() => setView("groups")} className="absolute left-4 top-4 text-green-200 hover:text-white text-xs font-bold flex items-center gap-1">â† Volver</button><h2 className="text-xl font-bold text-white mt-4">{selectedUnit} - {GROUPS.find((g) => g.id === selectedGroupId)?.name}</h2></div>â€¨Â  Â  Â  Â  Â  <div className="p-6 grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto">{activeMembers.map((m) => (<button key={m.id} disabled={!m.active} onClick={() => handleLoginAttempt(m)} className={`p-3 rounded-xl border text-left ${!m.active ? "bg-gray-50 opacity-50" : "bg-white border-green-100 hover:border-emerald-500"}`}><div className="flex flex-col"><span className="font-bold text-green-900 text-sm">{m.name}</span></div></button>))}</div>â€¨Â  Â  Â  Â  Â  <div className="bg-green-50 p-3 text-center border-t border-green-100"><button onClick={() => handleLoginAttempt({ id: "admin", name: "SupervisiÃ³n" })} className="text-xs text-green-600 font-bold flex items-center justify-center gap-1 mx-auto"><Shield className="w-3 h-3" /> SupervisiÃ³n</button></div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  ) : (â€¨Â  Â  Â  Â  <div className="bg-white rounded-2xl shadow-2xl max-w-xs w-full p-6 text-center border border-green-100">â€¨Â  Â  Â  Â  Â  <h2 className="text-xl font-bold text-green-900 mb-4">Hola, {loginMember.name}</h2>â€¨Â  Â  Â  Â  Â  <form onSubmit={submitPin}><input type="password" inputMode="numeric" maxLength={4} value={pinInput} onChange={(e) => setPinInput(e.target.value)} className="w-full text-center text-3xl font-bold py-3 border-2 rounded-xl mb-4" placeholder="****" autoFocus /><button type="submit" className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg">Entrar</button></form>â€¨Â  Â  Â  Â  Â  <button onClick={() => setLoginMember(null)} className="mt-4 text-green-400 text-sm">Cancelar</button>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨Â  Â  </div>â€¨Â  );â€¨â€¨Â  // DASHBOARDâ€¨Â  const limits = currentUser ? getUserLimits(currentUser.id) : {};â€¨Â  const myV25 = getUsed(currentUser?.id, "vacation", "2025"); const myV26 = getUsed(currentUser?.id, "vacation", "2026");â€¨Â  const myAP25 = getUsed(currentUser?.id, "ap", "2025"); const myAP26 = getUsed(currentUser?.id, "ap", "2026");â€¨â€¨Â  const navValidation = selectionStats ? validateSpecialRange(selectionStats.range, "nav") : { ok: false };â€¨Â  const ssValidation = selectionStats ? validateSpecialRange(selectionStats.range, "ss") : { ok: false };â€¨â€¨Â  return (â€¨Â  Â  <div className="min-h-screen bg-green-50/30 font-sans text-slate-900 pb-20 relative">â€¨Â  Â  Â  {selectionStart && !selectionEnd && (<div className="fixed bottom-0 left-0 right-0 bg-emerald-600 text-white p-4 z-[150] flex justify-between"><div><div className="font-bold text-sm">ğŸ“† Inicio: {selectionStart}</div></div><button onClick={() => setSelectionStart(null)} className="bg-emerald-700 px-3 py-1 rounded text-xs font-bold">Cancelar</button></div>)}â€¨Â  Â  Â  â€¨Â  Â  Â  {/* MODAL CONFIG */}â€¨Â  Â  Â  {showSettingsModal && (â€¨Â  Â  Â  Â  <div className="fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">â€¨Â  Â  Â  Â  Â  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-green-100">â€¨Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-green-900 mb-4 flex items-center gap-2"><Settings className="w-5 h-5" /> ConfiguraciÃ³n</h3>â€¨Â  Â  Â  Â  Â  Â  <div className="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  <div className="p-3 bg-green-50 rounded-xl border border-green-100"><h4 className="text-xs font-bold text-green-800 uppercase mb-2">Saldos 2025</h4><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] text-slate-500 font-bold block mb-1">Vacaciones</label><input type="number" value={tempSettings.vac25} onChange={(e) => setTempSettings({...tempSettings, vac25: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded font-bold text-center" /></div><div><label className="text-[10px] text-slate-500 font-bold block mb-1">Asuntos Propios</label><input type="number" value={tempSettings.ap25} onChange={(e) => setTempSettings({...tempSettings, ap25: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded font-bold text-center" /></div></div></div>â€¨Â  Â  Â  Â  Â  Â  Â  <div className="p-3 bg-emerald-50 rounded-xl border border-emerald-100"><h4 className="text-xs font-bold text-emerald-800 uppercase mb-2">Saldos 2026</h4><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] text-slate-500 font-bold block mb-1">Vacaciones</label><input type="number" value={tempSettings.vac26} onChange={(e) => setTempSettings({...tempSettings, vac26: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded font-bold text-center" /></div><div><label className="text-[10px] text-slate-500 font-bold block mb-1">Asuntos Propios</label><input type="number" value={tempSettings.ap26} onChange={(e) => setTempSettings({...tempSettings, ap26: parseInt(e.target.value) || 0})} className="w-full p-2 border rounded font-bold text-center" /></div></div></div>â€¨Â  Â  Â  Â  Â  Â  Â  <div className="p-3 bg-slate-50 rounded-xl border border-slate-200"><h4 className="text-xs font-bold text-slate-700 uppercase mb-2 flex items-center gap-1"><Key className="w-3 h-3"/> Cambiar PIN</h4><input type="password" inputMode="numeric" maxLength={4} placeholder="Nuevo PIN (4 dÃ­gitos)" value={newPin} onChange={(e) => setNewPin(e.target.value)} className="w-full p-2 border rounded font-bold text-center tracking-widest" /></div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  <div className="flex gap-3 mt-6"><button onClick={() => setShowSettingsModal(false)} className="flex-1 py-3 text-slate-500 font-bold text-sm">Cancelar</button><button onClick={saveSettings} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-200">Guardar</button></div>â€¨Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨â€¨Â  Â  Â  {showServiceModal && (â€¨Â  Â  Â  Â  <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">â€¨Â  Â  Â  Â  Â  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-green-100 h-[80vh] flex flex-col">â€¨Â  Â  Â  Â  Â  Â  <div className="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0"><h3 className="font-bold text-lg flex items-center gap-2"><Briefcase /> Servicio {new Date(serviceDate).toLocaleDateString()}</h3><button onClick={() => setShowServiceModal(false)}><X /></button></div>â€¨Â  Â  Â  Â  Â  Â  <div className="p-4 space-y-6 overflow-y-auto flex-1 bg-slate-50">â€¨Â  Â  Â  Â  Â  Â  Â  <div><h4 className="font-bold text-blue-900 uppercase text-sm border-b border-blue-200 mb-2">Fuerza Motorista</h4>{["M", "T", "N"].map(s => (<div key={s} className="mb-2"><span className="font-bold text-xs">{s === "M" ? "MAÃ‘ANA" : s === "T" ? "TARDE" : "NOCHE"}</span><div className="bg-white p-2 border rounded text-xs">{serviceData.moto[s].length > 0 ? serviceData.moto[s].join(", ") : "Sin efectivos"}</div></div>))}</div>â€¨Â  Â  Â  Â  Â  Â  Â  <div><h4 className="font-bold text-indigo-900 uppercase text-sm border-b border-indigo-200 mb-2">Equipo Atestados</h4>{["M", "N"].map(s => (<div key={s} className="mb-2"><span className="font-bold text-xs">{s === "M" ? "MAÃ‘ANA/DÃA" : "NOCHE"}</span><div className="bg-white p-2 border rounded text-xs">{serviceData.eis[s].length > 0 ? serviceData.eis[s].join(", ") : "Sin efectivos"}</div></div>))}</div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨â€¨Â  Â  Â  {showModal && !showYearSelector && !showSettingsModal && (â€¨Â  Â  Â  Â  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">â€¨Â  Â  Â  Â  Â  <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 border border-green-100 overflow-y-auto max-h-[90vh]">â€¨Â  Â  Â  Â  Â  Â  {selectedRequestToDelete ? (â€¨Â  Â  Â  Â  Â  Â  Â  <div className="text-center"><Trash2 className="w-12 h-12 text-red-500 mx-auto mb-4" /><h3 className="font-bold text-slate-800">Â¿Borrar solicitud?</h3><div className="flex gap-3 mt-4"><button onClick={closeAllModals} className="flex-1 py-2 bg-slate-100 rounded">No</button><button onClick={deleteRequest} className="flex-1 py-2 bg-red-500 text-white rounded">SÃ­, Borrar</button></div></div>â€¨Â  Â  Â  Â  Â  Â  ) : selectedOverrideToDelete ? (â€¨Â  Â  Â  Â  Â  Â  Â  <div className="text-center"><Undo2 className="w-12 h-12 text-orange-500 mx-auto mb-4" /><h3 className="font-bold text-slate-800">Â¿Restaurar turno?</h3><p className="text-xs text-slate-500 mt-2 mb-4">Se anularÃ¡ el cambio de servicio y volverÃ¡s a tu turno original.</p><div className="flex gap-3 mt-4"><button onClick={closeAllModals} className="flex-1 py-2 bg-slate-100 rounded text-slate-600 hover:bg-slate-200">Cancelar</button><button onClick={deleteOverride} className="flex-1 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 shadow">SÃ­, Restaurar</button></div></div>â€¨Â  Â  Â  Â  Â  Â  ) : !showShiftChange ? (â€¨Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="text-lg font-bold text-green-900 mb-2">GestiÃ³n de DÃ­a</h3>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => calculateService(selectionStats.range[0])} className="w-full mb-4 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm flex items-center justify-center gap-2"><CalendarCheck /> ğŸ‘®â€â™‚ï¸ Ver Servicio Diario</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  {modalError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs mb-4 font-bold border border-red-200">ğŸš¨ {modalError}</div>}â€¨Â  Â  Â  Â  Â  Â  Â  Â  {isWorkingDay ? (â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-2 mb-6">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => initiateRequest("vacation")} className="w-full flex justify-between p-3 bg-emerald-50 border border-emerald-200 rounded-lg"><div className="flex gap-2"><Briefcase className="w-4 h-4" /> <span className="text-sm font-bold">Vacaciones</span></div><div className="text-[10px] text-right"><div>'25: {limits.vac25 - myV25}</div><div>'26: {limits.vac26 - myV26}</div></div></button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => initiateRequest("ap")} className="w-full flex justify-between p-3 bg-purple-50 border border-purple-200 rounded-lg"><div className="flex gap-2"><UserCheck className="w-4 h-4" /> <span className="text-sm font-bold">Asuntos Propios</span></div><div className="text-[10px] text-right"><div>'25: {limits.ap25 - myAP25}</div><div>'26: {limits.ap26 - myAP26}</div></div></button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-1"><button onClick={() => initiateRequest("ss")} disabled={!ssValidation.ok} className={`w-full p-3 border rounded-lg font-bold text-sm ${ssValidation.ok ? "bg-orange-50 border-orange-200 text-orange-900" : "bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed"}`}>Semana Santa</button><p className="text-[10px] text-slate-500 font-medium text-center">{ssValidation.reason}</p></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-1"><button onClick={() => initiateRequest("nav")} disabled={!navValidation.ok} className={`w-full p-3 border rounded-lg font-bold text-sm ${navValidation.ok ? "bg-red-50 border-red-200 text-red-900" : "bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed"}`}>Navidad</button><p className="text-[10px] text-slate-500 font-medium text-center">{navValidation.reason}</p></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => processRequest("baja", "2026")} className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg font-bold text-sm text-slate-600">Baja MÃ©dica</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  ) : (â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-xs text-yellow-800 mb-4 text-center">Hoy libras, solo puedes cambiar servicio.</div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  )}â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-2">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="text-xs text-blue-600 font-bold uppercase tracking-wide mb-1">Operativa</div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => setShowShiftChange(true)} className="w-full p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-blue-900 font-bold text-sm flex items-center gap-2 transition-colors"><RefreshCw className="w-4 h-4" /> ğŸ”„ Cambio de Servicio</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={closeAllModals} className="mt-4 w-full text-slate-400 text-sm hover:text-slate-600">Cancelar</button>â€¨Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  ) : (â€¨Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2"><RefreshCw className="w-5 h-5" /> Cambio de Turno</h3>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-xs text-slate-500 mb-4">DÃ­a seleccionado: {selectionStart}</p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div className="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="bg-slate-50 p-3 rounded-xl border border-slate-200"><h4 className="font-bold text-slate-800 text-sm mb-2">1. Necesidades del Servicio</h4><div className="flex gap-2">{["M", "T", "N"].map((shift) => (<button key={shift} onClick={() => applyServiceChange(shift)} className={`flex-1 py-2 rounded-lg font-bold text-sm border ${SHIFT_STYLES[shift].bg} ${SHIFT_STYLES[shift].text} hover:opacity-80`}>{shift}</button>))}</div></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="bg-blue-50 p-3 rounded-xl border border-blue-200"><h4 className="font-bold text-blue-800 text-sm mb-2">2. Cambiar con CompaÃ±ero</h4><div className="flex gap-2 mb-2">{["M", "T", "N"].map((shift) => (<button key={shift} onClick={() => setSwapTargetShift(shift)} className={`flex-1 py-2 rounded-lg font-bold text-sm border transition-all ${swapTargetShift === shift ? "bg-blue-600 text-white ring-2 ring-blue-300" : "bg-white text-slate-600 hover:bg-slate-100"}`}>{shift}</button>))}</div><button onClick={() => requestSwap(swapTargetShift)} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-blue-700 flex items-center justify-center gap-2"><ArrowRightLeft className="w-4 h-4" /> Solicitar Cambio</button></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-200"><h4 className="font-bold text-indigo-800 text-sm mb-2 flex items-center gap-2"><Star className="w-3 h-3"/> 3. Servicios Especiales</h4><div className="grid grid-cols-2 gap-2">{SPECIAL_SERVICES_LIST.map((svc) => (<button key={svc} onClick={() => applyServiceChange(svc)} className="py-2 px-1 bg-white border border-indigo-100 rounded text-[10px] font-bold text-indigo-700 hover:bg-indigo-100 truncate shadow-sm">{svc}</button>))}</div></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => setShowShiftChange(false)} className="mt-4 w-full text-slate-400 text-sm hover:text-slate-600">Volver</button>â€¨Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  )}â€¨Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨â€¨Â  Â  Â  {showYearSelector && (â€¨Â  Â  Â  Â  <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 p-4">â€¨Â  Â  Â  Â  Â  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 className="text-lg font-bold text-slate-800 mb-2">ğŸ“… Periodo de Solapamiento</h3><div className="space-y-3"><button onClick={() => processRequest(pendingRequestType, "2025")} className="w-full p-4 bg-orange-100 rounded-xl border font-bold">Cupo 2025</button><button onClick={() => processRequest(pendingRequestType, "2026")} className="w-full p-4 bg-emerald-100 rounded-xl border font-bold">Cupo 2026</button></div><button onClick={closeAllModals} className="mt-4 text-slate-400 text-sm">Cancelar</button></div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨â€¨Â  Â  Â  <nav className="bg-green-900 text-white shadow-lg sticky top-0 z-40">â€¨Â  Â  Â  Â  <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">â€¨Â  Â  Â  Â  Â  <div className="flex items-center gap-3"><img src={LOGO_URL} className="w-8 h-8 bg-white rounded-full p-0.5" /><div><div className="font-bold text-sm">{currentUser.name}</div><button onClick={() => setShowSettingsModal(true)} className="text-[10px] text-emerald-300 flex items-center gap-1"><Settings className="w-3 h-3" /> Ver/Editar Saldos</button></div></div>â€¨Â  Â  Â  Â  Â  <div className="flex items-center gap-3">â€¨Â  Â  Â  Â  Â  Â  <button onClick={() => openPopup(GPT_URL, "GPT TrÃ¡fico")} className="p-2 text-emerald-300"><Bot className="w-6 h-6" /></button>â€¨Â  Â  Â  Â  Â  Â  <button onClick={() => openPopup(FORM_PERMISOS_URL, "Permisos")} className="p-2 text-emerald-300"><Car className="w-6 h-6" /></button>â€¨Â  Â  Â  Â  Â  Â  <button onClick={() => setShowChat(true)} className="relative p-2 text-green-300"><MessageCircle className="w-6 h-6" />{unreadCount > 0 && <span className="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full" />}</button>â€¨Â  Â  Â  Â  Â  Â  <button onClick={handleLogout} className="p-2 text-green-300"><LogOut className="w-6 h-6" /></button>â€¨Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  </nav>â€¨â€¨Â  Â  Â  {showChat && (â€¨Â  Â  Â  Â  <div className="fixed inset-0 z-[100] flex justify-end">â€¨Â  Â  Â  Â  Â  <div className="absolute inset-0 bg-black/20" onClick={() => setShowChat(false)} />â€¨Â  Â  Â  Â  Â  <div className="relative w-full max-w-md bg-white h-full shadow-2xl flex flex-col">â€¨Â  Â  Â  Â  Â  Â  <div className="bg-green-900 text-white p-4 flex justify-between items-center"><h3 className="font-bold">Chat</h3><button onClick={() => setShowChat(false)}><X /></button></div>â€¨Â  Â  Â  Â  Â  Â  <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-green-50">{messages.map((msg) => (<div key={msg.id} className="border p-3 rounded bg-white text-xs shadow-sm">{msg.isSwap ? (<div className="space-y-2"><div className="flex items-center justify-between"><div className="font-bold text-blue-900">Solicitud de cambio</div><span className="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 font-bold">DÃ­a {msg.swapData.date}</span></div><div className="text-[11px] text-slate-700 space-y-1"><div><strong>Solicitante:</strong> {msg.swapData.requesterName}</div><div><strong>Turno:</strong> {msg.swapData.fromShift} â†’ {msg.swapData.toShift}</div></div>{msg.swapData.status === "accepted" ? (<div className="text-[11px] text-emerald-700 font-bold">âœ… Cambio realizado por {msg.swapData.acceptedBy}</div>) : (msg.swapData.status === "pending" && currentUser && msg.swapData.requesterId !== currentUser.id ? (<button onClick={() => acceptSwap(msg)} className="w-full py-2 bg-emerald-600 text-white rounded-lg font-bold text-xs hover:bg-emerald-700">ACEPTAR</button>) : (<div className="text-[11px] text-slate-500">Pendiente de aceptaciÃ³n...</div>))}</div>) : (<div>{msg.text}</div>)}</div>))}</div>â€¨Â  Â  Â  Â  Â  Â  <form onSubmit={sendMessage} className="p-3 bg-white border-t flex gap-2"><input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} className="flex-1 border rounded-full px-4 py-2 text-sm" placeholder="Mensaje..." /><button type="submit" className="text-emerald-600"><Send /></button></form>â€¨Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨Â  Â  Â  )}â€¨â€¨Â  Â  Â  <main className="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 pb-24">â€¨Â  Â  Â  Â  <div className="lg:col-span-1 space-y-4"><div className="bg-white p-5 rounded-xl shadow-sm border border-green-100"><h3 className="font-bold text-green-900 mb-4 flex items-center gap-2"><Users className="w-4 h-4" /> Estado {GROUPS.find((g) => g.id === selectedGroupId)?.name} (2026)</h3><div className="space-y-2">{activeMembers.filter((m) => m.active).map((m) => (<div key={m.id} className="text-xs flex justify-between border-b pb-1 border-green-50 last:border-0"><span className={m.id === currentUser.id ? "text-emerald-700 font-bold" : "text-slate-600"}>{m.name}</span><div className="flex gap-2 font-medium"><span className="text-emerald-600">V:{getUsed(m.id, "vacation", "2026")}/{getUserLimits(m.id).vac26}</span><span className="text-purple-600">AP:{getUsed(m.id, "ap", "2026")}/{getUserLimits(m.id).ap26}</span></div></div>))}</div></div></div>â€¨Â  Â  Â  Â  <div className="lg:col-span-2">{loading ? <div className="p-10 text-center text-emerald-600 font-medium animate-pulse">Cargando...</div> : <div className="columns-1 xl:columns-2 gap-4 space-y-4">{calendarGrid}</div>}</div>â€¨Â  Â  Â  </main>â€¨Â  Â  </div>â€¨Â  );â€¨}â€¨â€¨
